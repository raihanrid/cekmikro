<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Judul disesuaikan -->
    <title>CekMikro - Deteksi Mikro Ekspresi</title>
    
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome (CDN) --><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    
    <!-- Inter Font --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Custom Styles --><style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Latar belakang abu-abu muda */
        }

        /* Custom gradient text */
        .text-gradient {
            background: linear-gradient(90deg, #6366f1 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Custom button glow - BLUE */
        .btn-glow {
            background: linear-gradient(90deg, #6366f1 0%, #818cf8 100%);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.4);
        }
        .btn-glow:hover {
            box-shadow: 0 0 25px rgba(99, 102, 241, 0.8);
        }
        
        /* Custom button glow - RED */
        .btn-glow-danger {
            background: linear-gradient(90deg, #ef4444 0%, #f87171 100%); /* red-600 to red-400 */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); /* red-600 shadow */
            color: white;
        }
        .btn-glow-danger:hover:not(:disabled) {
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.8);
        }

        /* Navbar scroll effect */
        .navbar-scrolled {
            background-color: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* AI Ring Animation (di dalam kotak hasil) */
        .result-ring {
            position: absolute;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            pointer-events: none;
        }
        .result-ring-1 {
            width: 220px;
            height: 220px;
            animation: rotate 20s linear infinite;
        }
        .result-ring-2 {
            width: 260px;
            height: 260px;
            animation: rotate 30s linear infinite reverse;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Perbaikan Tampilan Video & Gambar */
        video {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            transform: scaleX(-1); /* Membalik video (mirror mode) */
        }
        img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }

        /* Style Bounding Box - Bentuk Kotak */
        #boundingBox {
            position: absolute;
            /* Posisi tengah statis */
            top: 50%;
            left: 50%;
            width: 40%;
            height: 55%;

            border: 3px solid rgba(59, 130, 246, 0.8); /* Biru tegas */
            border-radius: 8px; /* Sudut agak melengkung (opsional, bisa ubah ke 0 untuk benar-benar kotak) */
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            pointer-events: none;
            transition: opacity 0.3s ease;
            /* Transform diatur oleh animasi */
        }

        /* Animasi Bounding Box "Drift" (Halus dan natural) */
        @keyframes drift {
            0% {
                transform: translateX(-50%) translateY(-50%) scale(1);
            }
            25% {
                transform: translateX(-51%) translateY(-51%) scale(1.01);
            }
            50% {
                transform: translateX(-49%) translateY(-49%) scale(1);
            }
            75% {
                transform: translateX(-50%) translateY(-52%) scale(1.01);
            }
            100% {
                transform: translateX(-50%) translateY(-50%) scale(1);
            }
        }

        /* Terapkan animasi hanya saat bounding box terlihat (tidak hidden) */
        #boundingBox:not(.hidden) {
            animation: drift 4s ease-in-out infinite alternate;
        }

        /* Style Deskripsi FACS */
        #facsDescriptionContainer {
            background-color: #f9fafb; /* bg-gray-50 */
            padding: 1rem;
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #e5e7eb; /* border-gray-200 */
        }
        #facsDescriptionContainer h4 {
            font-weight: 600; /* font-semibold */
            color: #4338ca; /* text-indigo-700 */
            margin-bottom: 0.5rem;
            font-size: 1.125rem; /* text-lg */
        }
        #facsDescriptionContainer p {
            color: #374151; /* text-gray-700 */
        }
    </style>
</head>
<body class="bg-gray-100">

<!-- üåê Header Dashboard (Modifikasi) --><nav class="bg-white shadow-md w-full fixed top-0 left-0 z-50">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
            
            <!-- Logo --><a class="text-2xl font-bold text-gradient d-flex items-center" href="/">
                <i class="fa-solid fa-face-smile mr-2 text-indigo-600"></i>
                CekMikro
            </a>

            <!-- Menu (Desktop) - Modifikasi -->
            <div class="hidden md:flex space-x-6 items-center">
            </div>
            
            <!-- Mobile Menu Button --><button id="mobile-menu-button" class="md:hidden text-2xl text-gray-700">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
    </div>
    
    <!-- Mobile Menu (Modifikasi) --><div id="mobile-menu" class="hidden md:hidden bg-white shadow-lg">
        <a class="block px-6 py-3 text-gray-600 hover:bg-indigo-50" href="/">
            <i class="fa-solid fa-house mr-2"></i>Home
        </a>
    </div>
</nav>

<!-- Konten Utama --><div class="container mx-auto px-4 pt-32 pb-16">
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>

    <!-- Judul Halaman --><div class="text-center mb-10">
        <h1 class="text-4xl lg:text-5xl font-extrabold text-gray-900 mb-4">
            Uji Coba <span class="text-gradient">CekMikro - Ekspresi</span>
        </h1>
        <p class="text-lg text-gray-600 max-w-3xl mx-auto">
            Mulai Kamera Anda atau Unggah Gambar Untuk Di Analisis Oleh Model 3D CNN.
        </p>
    </div>

    <!-- Grid Utama (MODIFIKASI: Ditambahkan lg:items-stretch) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-6xl mx-auto lg:items-stretch">

        <!-- Kolom Kiri: Panel Kontrol --><div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Panel Kontrol</h2>

            <!-- Tampilan Media (Modifikasi Container) --><div class="relative bg-gray-100 rounded-lg w-full max-h-96 min-h-[250px] mb-6 overflow-hidden">
                <video id="videoElement" class="hidden w-full h-full" autoplay playsinline></video>
                <img id="imageDisplay" class="hidden w-full h-full" alt="Unggahan Gambar">

                <!-- Bounding Box (Hidden by default) --><div id="boundingBox" class="hidden"></div>
                <div id="mediaPlaceholder" class="absolute inset-0 flex items-center justify-center">
                    <i class="fa-solid fa-video text-6xl text-gray-300"></i>
                </div>
            </div>

            <!-- Tombol Aksi Kamera --><div class="grid grid-cols-2 gap-4 mb-4">
                <button id="startButton" class="btn-glow w-full flex items-center justify-center px-6 py-3 rounded-full text-white font-semibold text-lg shadow-lg transition-all duration-300 hover:scale-105">
                    <i class="fa-solid fa-video mr-2"></i> Mulai Kamera
                </button>
                <button id="stopButton" disabled
                        class="w-full flex items-center justify-center px-6 py-3 rounded-full text-white font-semibold text-lg shadow-lg transition-all duration-300 hover:scale-105 
                        btn-glow-danger 
                        disabled:bg-gradient-none disabled:bg-gray-200 disabled:text-gray-500 disabled:cursor-not-allowed disabled:shadow-none disabled:hover:scale-100">
                    <i class="fa-solid fa-video-slash mr-2"></i> Hentikan
                </button>
            </div>

            <!-- Pemisah --><div class="flex items-center my-6">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="flex-shrink mx-4 text-sm font-medium text-gray-400">ATAU</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>

            <!-- Tombol Aksi Unggah --><div class="grid grid-cols-2 gap-4">
                <label for="uploadImage" class="w-full flex items-center justify-center px-6 py-3 rounded-full font-semibold text-lg border-2 border-indigo-600 text-indigo-600 hover:bg-indigo-50 transition-all cursor-pointer">
                    <i class="fa-solid fa-image mr-2"></i> Upload Gambar
                </label>
                <input type="file" id="uploadImage" accept="image/*" class="hidden">
                
                <button id="analyzeImageButton" disabled
                        class="w-full flex items-center justify-center px-6 py-3 rounded-full font-semibold text-lg bg-indigo-600 text-white shadow-lg transition-all disabled:bg-gray-200 disabled:text-gray-500 disabled:shadow-none cursor-pointer disabled:cursor-not-allowed">
                    <i class="fa-solid fa-microchip mr-2"></i> Analisis Gambar
                </button>
            </div>
        </div>

        <!-- Kolom Kanan: Hasil & Panduan (MODIFIKASI: Dibuat flex-col agar stretch) -->
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl flex flex-col">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Hasil Deteksi</h2>

            <!-- Kotak Hasil Modern --><div class="relative bg-gradient-to-br from-indigo-900 to-purple-800 rounded-2xl p-8 text-center min-h-[200px] flex flex-col justify-center items-center overflow-hidden">
                <!-- Animasi Ring Latar Belakang --><div class="result-ring result-ring-1"></div>
                <div class="result-ring result-ring-2"></div>
                
                <!-- Konten Hasil --><div id="emotionResultWrapper" class="z-10">
                    <div id="emotionResult" class="text-2xl font-medium text-indigo-200">
                        Menunggu Input ...
                    </div>
                    <!-- Elemen baru untuk Confidence Score --><div id="confidenceScore" class="text-xl font-medium text-indigo-300 mt-2"></div>
                </div>
            </div>

            <!-- Deskripsi FACS --><h3 class="text-xl font-semibold text-gray-900 mt-8 mb-4">Deskripsi Action Units (FACS)</h3>
            <div id="facsDescriptionContainer">
                <!-- Konten FACS akan diisi oleh JavaScript --><p class="text-gray-500" id="facsDescription">Deskripsi FACS Akan Terlihat Disini ...</p>
            </div>
            
            <!-- Cara Penggunaan --><h3 class="text-xl font-semibold text-gray-900 mt-8 mb-4">Cara Kerja Sistem</h3>
            <ol class="list-decimal list-inside space-y-3 text-gray-600">
                <li>Klik <strong>"Mulai Kamera"</strong> Untuk Mengaktifkan Webcam. Sistem Akan Mengumpulkan Sekuens Frame Secara Otomatis.</li>
                <li>Atau, klik <strong>"Upload Gambar"</strong> Lalu <strong>"Analisis Gambar"</strong>.</li>
                <li>Hasil Emosi Yang Terdeteksi Akan Muncul di Panel "Hasil Deteksi".</li>
            </ol>

            <!-- Catatan (MODIFIKASI: Diberi mt-auto agar menempel ke bawah jika ada sisa ruang) -->
            <div class="mt-auto pt-8"> <!-- pt-8 untuk memberi jarak dari atas jika menempel -->
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Catatan :</h3>
                <p class="text-gray-600 bg-indigo-50 border-l-4 border-indigo-400 p-4 rounded-lg">
                    Demo Ini Terintegrasi Langsung Dengan Model 3D CNN Pada Bagian Backend.
                    <br>
                    <strong>Analisis Gambar :</strong> Model 3D CNN Memerlukan Sekuens Video. Analisis Gambar Statis adalah Simulasi (Mengirim 16 Salinan Gambar atau Frame) Untuk Memenuhi Input Model.
                </p>
            </div>

        </div>
    </div>
</div>

<!-- üîö Footer --><footer class="bg-gray-800 text-gray-400 py-8 mt-16">
    <div class="container mx-auto px-4 text-center">
        <p>&copy; 2025 <span class="font-semibold text-white">CekMikro</span>. All rights reserved.</p>
    </div>
</footer>

    <!-- JavaScript (Sama seperti aslinya, tidak diubah) --><script>
        // --- Kontrol Menu Mobile ---
        const menuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');

        menuButton.addEventListener('click', function() {
            mobileMenu.classList.toggle('hidden');
        });
        
        // --- Logika Aplikasi Deteksi ---
        const videoElement = document.getElementById('videoElement');
        const imageDisplay = document.getElementById('imageDisplay');
        const mediaPlaceholder = document.getElementById('mediaPlaceholder');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const uploadImageInput = document.getElementById('uploadImage');
        const analyzeImageButton = document.getElementById('analyzeImageButton');
        const emotionResult = document.getElementById('emotionResult');
        const confidenceScoreElement = document.getElementById('confidenceScore');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');

        // === TAMBAHAN: Elemen Baru ===
        const boundingBox = document.getElementById('boundingBox');
        const facsDescriptionElement = document.getElementById('facsDescription'); // Target <p> di dalam container
        // ============================

        // === BARU: Batas Confidence ===
        // Jika confidence di bawah ini, anggap tidak ada wajah terdeteksi
        const CONFIDENCE_THRESHOLD = 0.40; // 40%

        // === PERUBAHAN: Data FACS Diperbarui ===
        const facsData = {
            'netral': {
                au: 'Tidak Ada AU Dominan',
                desc: 'Tidak ada *action unit* (AU) dominan yang terdeteksi.'
            },
            'others': {
                au: 'Kombinasi AU Lainnya (4, 14+17, 12+14, 15+17, 17, 38)',
                desc: 'Terdeteksi kombinasi AU yang tidak spesifik atau campuran, sesuai dataset.'
            },
            'happy': {
                au: 'AU 6 (Cheek Raiser) + AU 12 (Lip Corner Puller)',
                desc: 'Pipi terangkat (menyebabkan kerutan di sudut mata) dan sudut bibir ditarik ke atas.'
            },
            'sad': {
                au: 'AU 1 (Inner Brow Raiser) + AU 4 (Brow Lowerer) + AU 15 (Lip Corner Depressor)',
                desc: 'Alis bagian dalam terangkat, alis diturunkan (menyatu), dan sudut bibir ditarik ke bawah.'
            },
            'angry': {
                au: 'AU 4 (Brow Lowerer) + AU 5 (Upper Lid Raiser) + AU 7 (Lid Tightener) + AU 23 (Lip Tightener)',
                desc: 'Alis turun dan menyatu, mata melotot, kelopak mata mengencang, dan bibir menipis.'
            },
            'surprise': {
                au: 'AU 1 + AU 2 (Outer Brow Raiser) + AU 5 (Upper Lid Raiser) + AU 26 (Jaw Drop)',
                desc: 'Seluruh alis terangkat, kelopak mata atas terangkat (mata terbelalak), dan rahang jatuh.'
            },
            'fear': {
                au: 'AU 1 + AU 2 + AU 4 (Alis terangkat & menyatu) + AU 5 + AU 20 (Lip Stretcher)',
                desc: 'Alis terangkat dan menyatu, kelopak mata atas terangkat, dan bibir ditarik horizontal.'
            },
            'disgust': {
                au: 'AU 9 (Nose Wrinkler) + AU 10 (Upper Lip Raiser)',
                desc: 'Hidung berkerut dan bibir atas terangkat.'
            },
            'repression': {
                au: 'Repression / Tertekan (12+15, 12+17, 14, 5+12)',
                desc: 'Terdeteksi kombinasi AU yang mengindikasikan penekanan emosi.'
            }
        };
        // ===========================

        let stream = null;
        let cameraIntervalId = null; 
        let frameBuffer = []; 
        const SEQUENCE_LENGTH = 16; 

        // Fungsi untuk menampilkan placeholder
        function showPlaceholder() {
            videoElement.classList.add('hidden');
            imageDisplay.classList.add('hidden');
            mediaPlaceholder.classList.remove('hidden');
        }
        // Fungsi untuk menampilkan video
        function showVideo() {
            videoElement.classList.remove('hidden');
            imageDisplay.classList.add('hidden');
            mediaPlaceholder.classList.add('hidden');
        }
        // Fungsi untuk menampilkan gambar
        function showImage() {
            videoElement.classList.add('hidden');
            imageDisplay.classList.remove('hidden');
            mediaPlaceholder.classList.add('hidden');
        }

        // Fungsi untuk mereset hasil
        function resetResult() {
            emotionResult.innerHTML = 'Menunggu Input...';
            emotionResult.className = 'text-2xl font-medium text-indigo-200';
            confidenceScoreElement.textContent = ''; // Reset confidence

            // === TAMBAHAN: Reset FACS & Bounding Box ===
            facsDescriptionElement.innerHTML = 'Deskripsi FACS akan muncul di sini...';
            facsDescriptionElement.parentElement.querySelector('h4')?.remove(); // Hapus H4 jika ada
            facsDescriptionElement.className = 'text-gray-500'; // Kembalikan style placeholder
            boundingBox.classList.add('hidden');
            // ======================================
        }

        // Fungsi untuk menampilkan hasil dari API (Diperbarui)
        function displayResult(emotion, confidence) {
            let emotionDisplay = emotion || 'Netral';
            let colorClass = 'text-white';
            let emoji = 'üòê'; // Emoji default
            let emotionKey = 'netral'; // Kunci untuk data FACS

            // === PERUBAHAN: Logika "Tidak Ada Wajah Terdeteksi" ===
            if (confidence && confidence < CONFIDENCE_THRESHOLD) {
                emoji = '‚ùì';
                emotionDisplay = 'Tidak Ada Wajah Terdeteksi';
                colorClass = 'text-yellow-300'; // Warna peringatan
                emotionKey = 'netral'; // Perlakukan seperti netral (tanpa box, FACS default)
            } else {
                // === PERBAIKAN BUG: Switch case disesuaikan (cth: 'happiness' bukan 'happy') ===
            switch (String(emotionDisplay).toLowerCase()) {
                case 'netral':
                        emoji = 'üòê';
                        emotionDisplay = 'Netral';
                        colorClass = 'text-white';
                        emotionKey = 'netral';
                        break;
                    case 'others':
                        emoji = 'ü§î'; // Ganti emoji untuk 'Others'
                        emotionDisplay = 'Others';
                        colorClass = 'text-gray-300';
                        emotionKey = 'others';
                        break;
                    case 'happiness': // DIUBAH DARI 'happy'
                        emoji = 'üòä';
                        emotionDisplay = 'Happy';
                        colorClass = 'text-yellow-300';
                        emotionKey = 'happy';
                    break;
                case 'sadness': // DIUBAH DARI 'sad'
                    emoji = 'üò¢';
                        emotionDisplay = 'Sad';
                        colorClass = 'text-blue-300';
                        emotionKey = 'sad';
                        break;
                    case 'anger': // DIUBAH DARI 'angry'
                        emoji = 'üò†';
                        emotionDisplay = 'Angry';
                        colorClass = 'text-red-300';
                        emotionKey = 'angry';
                        break;
                    case 'surprise': // DIUBAH DARI 'surprise'
                        emoji = 'üòÆ';
                        emotionDisplay = 'Surprise';
                        colorClass = 'text-purple-300';
                        emotionKey = 'surprise';
                        break;
                    case 'fear': // DIUBAH DARI 'fear'
                        emoji = 'üò®';
                        emotionDisplay = 'Fear';
                        colorClass = 'text-green-300';
                        emotionKey = 'fear';
                        break;
                    case 'disgust': // DIUBAH DARI 'disgust'
                        emoji = 'ü§¢';
                        emotionDisplay = 'Disgust';
                        colorClass = 'text-lime-300';
                        emotionKey = 'disgust';
                        break;
                    case 'repression': // BARU
                        emoji = 'üòë';
                        emotionDisplay = 'Repression';
                        colorClass = 'text-gray-300'; // Warna netral/subdued
                        emotionKey = 'repression';
                        break;
                    default:
                        emoji = 'üòê';
                        emotionDisplay = emotion; // Tampilkan apa adanya jika tidak dikenal
                        colorClass = 'text-white';
                        emotionKey = 'netral'; // Default ke netral jika tidak dikenal
                }
            }
            // ======================================================

            // Format final: üòä Happy
            emotionResult.innerHTML = `${emoji} ${emotionDisplay}`;
            emotionResult.className = `text-5xl font-extrabold z-10 ${colorClass}`;
            
            // Tampilkan confidence
            if (confidence) {
                confidenceScoreElement.textContent = `Confidence: ${(confidence * 100).toFixed(1)}%`;
            } else {
                confidenceScoreElement.textContent = '';
            }

            // === PERUBAHAN: Logika Bounding Box (Kembali ke Simulasi) ===
            // Sembunyikan jika netral, others, atau tidak terdeteksi
            if (emotionKey === 'netral' || emotionKey === 'others' || !emotion || (confidence && confidence < CONFIDENCE_THRESHOLD)) {
                 boundingBox.classList.add('hidden');
            } else {
                 // Tampilkan di posisi statis (animasi CSS akan menggerakkannya)
                 boundingBox.classList.remove('hidden');
            }
            // ========================================================

            // 2. Tampilkan Deskripsi FACS
            // Jika tidak terdeteksi, gunakan 'netral'
            const facsKeyToShow = (confidence && confidence < CONFIDENCE_THRESHOLD) ? 'netral' : emotionKey;
            const facs = facsData[facsKeyToShow] || facsData['netral'];
            const container = facsDescriptionElement.parentElement;
            
            // Hapus H4 lama jika ada
            container.querySelector('h4')?.remove();
            
            // Buat H4 baru
            const facsTitle = document.createElement('h4');
            facsTitle.textContent = facs.au;
            
            // Masukkan H4 sebelum <p>
            container.insertBefore(facsTitle, facsDescriptionElement);
            
            // Update deskripsi <p>
            facsDescriptionElement.textContent = facs.desc;
            facsDescriptionElement.className = 'text-gray-700'; // Hapus style placeholder
            // ========================================================
        }

        // === PERUBAHAN: Fungsi API untuk sekuens frame (Kamera) ===
        // Menargetkan /predict
        async function predictFromFrames(frames) {
            try {
                // Mengembalikan Panggilan API yang Sebenarnya
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    // Body sudah benar, mengirim 16 frame
                    body: JSON.stringify({ frames: frames }) 
                });

                if (!response.ok) {
                    const errData = await response.json();
                    console.error("API Error (/predict):", errData.error);
                    // Jangan tampilkan error jika masih dalam loop kamera,
                    // biarkan dia mencoba lagi di frame berikutnya.
                    if (!cameraIntervalId) { 
                        displayResult('Error', null);
                        confidenceScoreElement.textContent = errData.error || 'Request failed';
                    }
                    return; 
                }

                const data = await response.json();
                displayResult(data.emotion, data.confidence);

            } catch (err) {
                console.error("Fetch Error (/predict):", err);
                 // Hanya tampilkan error jika bukan dari mode kamera
                if (!cameraIntervalId) {
                    emotionResult.innerHTML = 'Koneksi Gagal';
                    emotionResult.className = 'text-2xl font-medium text-red-300';
                    confidenceScoreElement.textContent = '';
                }
            }
        }

        // === BARU: Fungsi API untuk satu gambar (Upload) ===
        // Menargetkan /predict_image
        async function predictFromImage(imageBase64) {
            try {
                const response = await fetch('/predict_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    // Kirim SATU gambar, sesuai endpoint /predict_image
                    body: JSON.stringify({ image: imageBase64 }) 
                });

                if (!response.ok) {
                    const errData = await response.json();
                    console.error("API Error (/predict_image):", errData.error);
                    displayResult('Error', null);
                    confidenceScoreElement.textContent = errData.error || 'Request failed';
                    return; 
                }

                const data = await response.json();
                // Panggil displayResult yang sama
                displayResult(data.emotion, data.confidence);

            } catch (err) {
                console.error("Fetch Error (/predict_image):", err);
                // Tampilkan error karena ini adalah aksi sekali jalan
                emotionResult.innerHTML = 'Koneksi Gagal';
                emotionResult.className = 'text-2xl font-medium text-red-300';
                confidenceScoreElement.textContent = '';
            }
        }


        // === PERUBAHAN: captureFrame (Disederhanakan, tanpa tracker) ===
        function captureFrame() {
            if (videoElement.readyState !== videoElement.HAVE_ENOUGH_DATA) return;

            // 1. Logika buffer frame untuk backend
            if (frameBuffer.length >= SEQUENCE_LENGTH) return; 

            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/jpeg');
            frameBuffer.push(dataUrl);

            if (frameBuffer.length === SEQUENCE_LENGTH) {
                // Kirim ke endpoint /predict
                predictFromFrames(frameBuffer); 
                frameBuffer = []; // Kosongkan buffer untuk sekuens berikutnya
            }
        }
        // =============================================================

        // === DIHAPUS: Event listener untuk hasil tracking.js ===
        // tracker.on('track', function(event) { ... });
        // ==================================================

        // Fungsi untuk memulai pengumpulan frame
        function startFrameCollection() {
            if (cameraIntervalId) clearInterval(cameraIntervalId);
            frameBuffer = []; 
            cameraIntervalId = setInterval(captureFrame, 33); 
        }

        // Fungsi untuk menghentikan pengumpulan frame
        function stopFrameCollection() {
            if (cameraIntervalId) {
                clearInterval(cameraIntervalId);
                cameraIntervalId = null;
            }
            frameBuffer = []; // Kosongkan buffer
        }
        
        // --- Event Listeners ---

        // Mulai Kamera
        startButton.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = stream;
                showVideo();
                
                startButton.disabled = true;
                stopButton.disabled = false;
                uploadImageInput.disabled = true;
                analyzeImageButton.disabled = true;
                
                resetResult(); 
                startFrameCollection(); 
            } catch (err) {
                console.error("Error mengakses kamera: ", err);
                resetResult();
                emotionResult.innerHTML = 'Kamera Gagal Dimuat';
                emotionResult.className = 'text-2xl font-medium text-red-300';
            }
        });

        // Hentikan Kamera
        stopButton.addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            stopFrameCollection(); 
            
            videoElement.srcObject = null;
            showPlaceholder();
            resetResult(); // Ini sudah termasuk menyembunyikan bounding box

            startButton.disabled = false;
            stopButton.disabled = true;
            uploadImageInput.disabled = false;
        });

        // === PERUBAHAN: Pilih Gambar ===
        uploadImageInput.addEventListener('change', () => {
            const file = uploadImageInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Panggil resetResult DULU untuk membersihkan FACS lama
                    resetResult(); 
                    
                    imageDisplay.src = e.target.result;
                    showImage();
                    
                    // BARU: Set status ke "Siap Dianalisis"
                    emotionResult.innerHTML = 'Gambar Siap Dianalisis';
                    emotionResult.className = 'text-2xl font-medium text-indigo-200';
                    confidenceScoreElement.textContent = ''; // Kosongkan confidence

                    if (stream) stopButton.click(); 
                    
                    analyzeImageButton.disabled = false;
                    startButton.disabled = true; 
                };
                reader.readAsDataURL(file);
            }
        });
        // ===================================

        // === PERUBAHAN: Analisis Gambar (Upload) ===
        analyzeImageButton.addEventListener('click', async () => { 
            if (!imageDisplay.src) return;

            resetResult();
            emotionResult.innerHTML = 'Menganalisis...';
            emotionResult.className = 'text-2xl font-medium text-indigo-200 animate-pulse';

            const dataUrl = imageDisplay.src;

            // Panggil fungsi BARU yang menargetkan endpoint /predict_image
            await predictFromImage(dataUrl); 
            
            // Reset UI
            analyzeImageButton.disabled = true;
            uploadImageInput.disabled = false;
            startButton.disabled = false;
            uploadImageInput.value = ''; // Hapus file yang dipilih
        });
        
        // Inisialisasi awal
        showPlaceholder();
        resetResult(); // Panggil saat load untuk memastikan FACS placeholder benar

    </script>
</body>
</html>